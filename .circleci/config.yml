version: 2.1

aliases:
  - &environ
    run:
      name: setup virtual environment
      # The below ensures the venv is activated for every subsequent step
      command: |
        virtualenv venv
        echo "source /home/circleci/project/venv/bin/activate" >> $BASH_ENV

  - &install
    run:
      name: install dependencies
      command: |
        pip install -U pip setuptools wheel tox codecov

  - &test-steps
    steps:
      - checkout
      - *environ
      - *install
      - run: tox -f $TOXFACTOR
      - run: coverage report
      - run: codecov

jobs:
  lint:
    steps:
      - checkout
      - *environ
      - *install
      - run: tox -e isort,lint
    docker:
      - image: circleci/python:3.13

  dist:
    steps:
      - checkout
      - *environ
      - *install
      - run: |
          python setup.py bdist_wheel
          tox -e dist --installpkg ./dist/djangorestframework_guardian-*.whl
          tox -e dist
    docker:
      - image: circleci/python:3.13

  test-py310:
    <<: *test-steps
    docker:
      - image: circleci/python:3.10
    environment:
      TOXFACTOR: py310

  test-py311:
    <<: *test-steps
    docker:
      - image: circleci/python:3.11
    environment:
      TOXFACTOR: py311

  test-py312:
    <<: *test-steps
    docker:
      - image: circleci/python:3.13
    environment:
      TOXFACTOR: py313

  test-py313:
    <<: *test-steps
    docker:
      - image: circleci/python:3.13
    environment:
      TOXFACTOR: py313


workflows:
  version: 2
  commit: &test-workflow
    jobs:
      - lint
      - dist:
          requires:
            - lint

      - test-py310:
          requires:
            - lint

      - test-py311:
          requires:
            - lint

      - test-py312:
          requires:
            - lint

      - test-py313:
          requires:
            - lint

  weekly:
    <<: *test-workflow
    triggers:
      - schedule:
          # 8/9 AM PST/PDT every Monday
          cron: "0 16 * * 1"
          filters:
            branches:
              only:
                - master
